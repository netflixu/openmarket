<!doctype html>
<html lang="ko-KR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HODU Shop</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
<!-- 헤더 -->
<header class="bg-white border-b">
  <div class="max-w-6xl mx-auto h-20 px-6 flex items-center gap-2">
    <!-- 로고 -->
    <a href="/" class="shrink-0 mr-5">
      <img src="../images/Logo-hodu.svg" alt="HODU" class="h-8 w-auto" />
    </a>

    <form class="flex-none !w-80 sm:w-64 md:w-72">
      <label class="relative block">
        <input
          type="search"
          placeholder="상품을 검색해보세요!"
          class="w-full h-10 pl-3 pr-16 rounded-full border-2 border-[#22C55E]
                 placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-[#22C55E]/40"
        />
        <button type="submit"
          class="absolute right-2 top-1.5 w-8 h-8 grid place-items-center bg-transparent text-[#22C55E]"
          aria-label="검색">
          <svg viewBox="0 0 24 24" class="w-6 h-6" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="9" r="8"></circle>
            <path d="M18 18 L16 16"></path>
          </svg>
        </button>
      </label>
    </form>

    <!-- 우측 아이콘 + 라벨 -->
    <nav class="ml-auto pl-8 flex items-end gap-8">
      <a href="#" class="flex flex-col items-center">
        <img src="../images/icon-shopping-cart.svg" alt="장바구니" class="w-7 h-7 object-contain" />
        <span class="mt-1 text-xs text-gray-500">장바구니</span>
      </a>
      <a href="#" class="flex flex-col items-center">
        <img src="../images/icon-user.svg" alt="마이페이지" class="w-7 h-7 object-contain" />
        <span class="mt-1 text-xs text-gray-500">마이페이지</span>
      </a>
    </nav>
  </div>
</header>

<!-- 상단 배너(슬라이더 자리) -->
<section class="relative bg-gray-100 h-72 flex items-center justify-center">
  <!-- 이전 -->
  <button class="absolute left-4 text-black/80 hover:text-black text-3xl font-bold"
          aria-label="이전">&#8249;</button>

  <div class="text-gray-400">배너/슬라이더 영역</div>

  <!-- 다음 -->
  <button class="absolute right-4 text-black/80 hover:text-black text-3xl font-bold"
          aria-label="다음">&#8250;</button>
</section>

<!-- 상품 리스트 -->
<main class="max-w-7xl mx-auto px-6 py-12">
  <!-- 그리드 컨테이너 -->
  <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-10 gap-y-16"></div>

  <!-- 로딩 스켈레톤 -->
  <template id="skeleton">
    <div class="bg-white shadow rounded-lg p-4 animate-pulse">
      <div class="w-full aspect-square bg-gray-200 rounded-md"></div>
      <div class="mt-4 h-4 bg-gray-200 rounded w-3/4"></div>
      <div class="mt-2 h-4 bg-gray-200 rounded w-1/3"></div>
    </div>
  </template>

  <!-- 오류 메시지 -->
  <p id="error" class="hidden mt-8 text-center text-sm text-red-600"></p>
</main>

<script>
  /** =========================
   *  설정
   *  ========================= */
  // 프런트 표기용 오버라이드 (비어있으면 API 그대로 사용)
  const OVERRIDES_BY_ID = {
    // 예시: 실제 id/문구에 맞춰 수정하세요. 비워두면 {} 그대로 두면 됨.
    // 5: { title: '버그를 Java라 버그잡는 개리씨 키링 개발자키링',price: 29000, seller: '파이썬스쿨' },
    // 4: { title: '우당탕탕 라이캣의 실험실 스티커 팩',price: 29000, seller: '코딩앤유' },
    // 3: { title: '딥러닝 개발자 무릎 담요',price: 29000, seller: '백엔드글로벌' },
    // 2: { title: '네 개발잡니다 개발자키링 금속키링',price: 29000, seller: '제주코딩베이스캠프' },
    // 1: { title: 'Hack Your Life 개발자 노트북 파우치', price: 29000, seller: '우당탕탕 라이캣의 실험실' },
  };

  // 오버라이드가 있을 때만 정렬을 적용 (asc | desc)
  const ORDER_WHEN_OVERRIDDEN = 'desc';

  // 네트워크 타임아웃(ms)
  const FETCH_TIMEOUT = 8000;

  // 서버 반영(PUT)은 기본 비활성화
  const SYNC_TO_SERVER = false;
  const AUTH_TOKEN = null;

  /** =========================
   *  유틸
   *  ========================= */
  const API_BASE = 'https://api.wenivops.co.kr/services/open-market';
  const PRODUCTS_URL = `${API_BASE}/products/`;
  const KRW = n => new Intl.NumberFormat('ko-KR').format(Number(n || 0));
  const toHttps = u => (u || '').replace(/^http:\/\//i, 'https://');
  const hasOverrides = Object.keys(OVERRIDES_BY_ID).length > 0;

  // PUT 유틸 (선택)
  async function putProduct(id, patch) {
    const headers = { 'Accept': 'application/json', 'Content-Type': 'application/json' };
    if (AUTH_TOKEN) headers.Authorization = `Bearer ${AUTH_TOKEN}`;
    const res = await fetch(`${API_BASE}/products/${id}/`, {
      method: 'PUT', headers, body: JSON.stringify(patch),
    });
    if (!res.ok) throw new Error(`HTTP ${res.status} (id:${id})`);
    return res.json();
  }
  async function syncOverridesToServer(map) {
    for (const [idStr, o] of Object.entries(map)) {
      const payload = {};
      if (o?.title !== undefined) payload.name = String(o.title); // 서버 필드명 name
      if (o?.price !== undefined) payload.price = Number(o.price);
      if (!Object.keys(payload).length) continue;
      await putProduct(Number(idStr), payload);
    }
  }

  // 최종 아이템 생성(정규화 + 오버라이드까지 한 번에)
  function buildItem(raw, idx) {
    const id = raw?.id ?? idx;
    const o  = hasOverrides ? OVERRIDES_BY_ID[id] : undefined;
    const title  = o?.title  ?? raw?.title ?? raw?.name ?? '상품명';
    const price  = o?.price  ?? Number(raw?.price ?? 0);
    const seller = (o?.seller !== undefined)
      ? String(o.seller)
      : (raw?.seller?.store_name ?? raw?.seller?.name ?? raw?.store_name ?? raw?.store ?? '');
    return {
      id,
      title: String(title),
      seller: String(seller || ''),
      price,
      image: toHttps(raw?.image ?? ''),
      stock: raw?.stock ?? 999,
    };
  }

  // 정렬 비교함수 (id 기준)
  function getIdComparator(order = 'desc') {
    return (a, b) => {
      const A = +a.id || 0, B = +b.id || 0;
      return order === 'asc' ? A - B : B - A;
    };
  }

  /** =========================
   *  렌더
   *  ========================= */
  function createCard(p) {
    const el = document.createElement('article');
    el.dataset.id = p.id;
    el.className = 'rounded-2xl p-4 bg-transparent';

    const fig = document.createElement('figure');
    fig.className = 'relative overflow-hidden rounded-[14px] border border-gray-300';

    const img = document.createElement('img');
    img.className = 'w-full aspect-square object-cover';
    img.alt = p.title || '상품 이미지';
    img.loading = 'lazy';
    img.src = p.image;
    fig.appendChild(img);

    const meta = document.createElement('p');
    meta.className = 'mt-3 text-[13px] text-gray-400';
    if (p.seller) meta.textContent = p.seller;

    const title = document.createElement('h3');
    title.className = 'mt-1 text-base leading-snug text-gray-900';
    title.style.display = '-webkit-box';
    title.style.webkitLineClamp = '2';
    title.style.webkitBoxOrient = 'vertical';
    title.style.overflow = 'hidden';
    title.textContent = p.title;

    const priceWrap = document.createElement('p');
    priceWrap.className = 'mt-3 flex items-baseline flex-wrap gap-x-2 gap-y-1';
    const strong = document.createElement('span');
    strong.className = 'text-2xl font-extrabold text-gray-900 align-baseline';
    strong.textContent = KRW(p.price);
    const won = document.createElement('span');
    won.className = 'ml-1 text-gray-900 align-baseline';
    won.textContent = '원';
    priceWrap.append(strong, won);

    el.append(fig, meta, title, priceWrap);
    return el;
  }

  // 스켈레톤 & 컨테이너
  const grid = document.getElementById('grid');
  const skelTpl = document.getElementById('skeleton')?.content;
  if (skelTpl) for (let i = 0; i < 8; i++) grid.appendChild(skelTpl.cloneNode(true));

  /** =========================
   *  엔트리
   *  ========================= */
  async function main() {
    const errorEl = document.getElementById('error');

    // 타임아웃이 있는 fetch
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort('timeout'), FETCH_TIMEOUT);

    try {
      const res = await fetch(PRODUCTS_URL, { headers: { Accept: 'application/json' }, signal: ctrl.signal });
      clearTimeout(timer);
      if (!res.ok) throw new Error('HTTP ' + res.status);

      const data = await res.json();
      const rawList = Array.isArray(data) ? data : (data.results || []);
      if (!Array.isArray(rawList)) throw new Error('Invalid payload');

      // 단일 for 루프로 정규화(+오버라이드) 수행
      const items = [];
      for (let i = 0; i < rawList.length; i++) {
        items.push(buildItem(rawList[i], i));
      }

      // 오버라이드가 있을 때만 정렬 실행(불필요한 비교 최소화)
      if (hasOverrides) items.sort(getIdComparator(ORDER_WHEN_OVERRIDDEN));

      // 배치 삽입으로 리플로우 최소화
      const frag = document.createDocumentFragment();
      for (let i = 0; i < items.length; i++) {
        frag.appendChild(createCard(items[i]));
      }
      grid.replaceChildren(frag);

      // 선택: 서버에 실제 반영
      if (SYNC_TO_SERVER && hasOverrides) {
        await syncOverridesToServer(OVERRIDES_BY_ID);
      }

    } catch (err) {
      clearTimeout(timer);
      grid.innerHTML = '';
      errorEl.textContent = `상품 정보를 불러오지 못했습니다. (${err.message || err})`;
      errorEl.classList.remove('hidden');
      console.error('[shop:error]', err);
    }
  }

  main();
</script>

<footer class="bg-gray-100">
  <div class="max-w-6xl mx-auto px-8 py-10">
    <!-- 상단: 링크 + 소셜 -->
    <div class="flex items-center justify-between text-sm">
      <ul class="flex flex-wrap items-center text-gray-700">
        <li><a href="#" class="hover:text-black">호두샵 소개</a></li>
        <span class="mx-3 text-gray-300">|</span>
        <li><a href="#" class="hover:text-black">이용약관</a></li>
        <span class="mx-3 text-gray-300">|</span>
        <li><a href="#" class="font-semibold text-black">개인정보처리방침</a></li>
        <span class="mx-3 text-gray-300">|</span>
        <li><a href="#" class="hover:text-black">전자금융거래약관</a></li>
        <span class="mx-3 text-gray-300">|</span>
        <li><a href="#" class="hover:text-black">청소년보호정책</a></li>
        <span class="mx-3 text-gray-300">|</span>
        <li><a href="#" class="hover:text-black">제휴문의</a></li>
      </ul>

      <div class="flex items-center gap-4">
        <a href="#" aria-label="Instagram">
          <img src="../images/icon-insta.svg" alt="Instagram" class="w-7 h-7" />
        </a>
        <a href="#" aria-label="Facebook">
          <img src="../images/icon-fb.svg" alt="Facebook" class="w-7 h-7" />
        </a>
        <a href="#" aria-label="YouTube">
          <img src="../images/icon-yt.svg" alt="YouTube" class="w-7 h-7" />
        </a>
      </div>
    </div>

    <hr class="mt-5 border-gray-300">

    <!-- 회사 정보 -->
    <div class="mt-6 text-sm leading-relaxed text-gray-500">
      <p class="font-semibold text-gray-500">(주)HODU SHOP</p>
      <p class="mt-1">제주특별자치도 제주시 동광고 137 제주코딩베이스캠프</p>
      <p class="mt-1">사업자 번호 : 000-0000-0000 | 통신판매업</p>
      <p class="mt-1">대표 : 김호두</p>
    </div>
  </div>
</footer>
</body>
</html>